<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>نظام إدارة المخزن - النسخة النهائية</title>
<style>
  :root {
    --primary-color: #0b74de;
    --secondary-color: #f6f7fb;
    --danger-color: #b91c1c;
    --success-color: #15803d;
    --border-radius: 8px;
    --box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  }

  body {
    font-family: 'Tahoma', Arial, sans-serif;
    background: var(--secondary-color);
    margin: 0;
    padding: 12px;
    direction: rtl;
    line-height: 1.6;
  }

  .card {
    background: #fff;
    padding: 12px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 14px;
    transition: box-shadow 0.3s ease;
  }

  .card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }

  input, select, textarea, button {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    width: 100%;
    box-sizing: border-box;
    margin-top: 6px;
    transition: border 0.3s ease;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--primary-color);
    outline: none;
  }

  button.primary {
    background: var(--primary-color);
    color: #fff;
    border: 0;
    padding: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button.primary:hover {
    background: #095fb4;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    background: #fff;
  }

  th, td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    text-align: right;
  }

  th {
    background-color: #f5f5f5;
    font-weight: 600;
  }

  tr:hover {
    background-color: #f9f9f9;
  }

  .muted {
    color: #666;
    font-size: 13px;
  }

  .hidden {
    display: none;
  }

  .row {
    display: flex;
    gap: 8px;
  }

  .col {
    flex: 1;
  }

  .actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  small {
    color: #666;
  }

  .top-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn-ghost {
    background: #fff;
    border: 1px solid #ddd;
    padding: 6px;
    border-radius: var(--border-radius);
    cursor: pointer;
  }

  .note {
    font-size: 12px;
    color: #666;
  }

  #brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #brand img {
    height: 48px;
    width: auto;
    border-radius: var(--border-radius);
  }

  .center {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .admin-only {
    display: none;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-20px); }
  }

  @media (max-width: 768px) {
    .row {
      flex-direction: column;
    }
    
    .actions, .top-actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    button {
      width: 100%;
      margin-bottom: 8px;
    }
  }
</style>
</head>
<body>

<!-- ======= تسجيل الدخول ======= -->
<div id="loginCard" class="card">
  <h3>تسجيل الدخول</h3>

  <label>اسم الشركة</label>
  <input id="companyNameInput" placeholder="اكتب اسم الشركة هنا" />

  <label>رفع لوجو الشركة (سيحفظ محليًا)</label>
  <input id="companyLogoInput" type="file" accept="image/*" />

  <hr/>

  <label>اسم المستخدم</label><input id="loginUser" />
  <label>كلمة المرور</label><input id="loginPass" type="password" />
  <div style="display:flex;gap:8px;margin-top:8px">
    <button class="primary" onclick="doLogin()">دخول</button>
    <button onclick="clearBrand()">مسح بيانات الشركه</button>
  </div>
  <p id="loginError" style="color:var(--danger-color);display:none"></p>
</div>

<!-- ======= التطبيق (مخفي حتى تسجيل الدخول) ======= -->
<div id="appArea" class="hidden">

  <div class="card" id="headerCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="brand">
        <img id="brandLogo" src="" alt="" class="hidden"/>
        <div>
          <div id="brandName" style="font-weight:700"></div>
          <div class="muted" id="brandSubtitle"></div>
        </div>
      </div>
      <div class="actions">
        <button onclick="nav('dashboard')">الرئيسية</button>
        <button onclick="nav('sale')">إضافة مبيعات</button>
        <button onclick="nav('purchase')">إضافة مشتريات</button>
        <button onclick="nav('stock')">رصيد المخزن</button>
        <button id="btnProducts" onclick="nav('products')">الأصناف</button>
        <button id="btnSuppliers" onclick="nav('suppliers')">الموردين</button>
        <button id="btnCustomers" onclick="nav('customers')">العملاء</button>
        <button id="btnUsers" onclick="nav('users')">المستخدمين</button>
        <button onclick="nav('importExport')">استيراد/تصدير</button>
        <button onclick="backup()">نسخة احتياطية</button>
        <button onclick="restorePrompt()">استعادة</button>
        <button onclick="logout()">تسجيل خروج</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="card section">
    <h3>لوحة التحكم</h3>
    <div class="row">
      <div class="col card"><small class="muted">عدد الأصناف</small><div id="statItems" style="font-weight:700"></div></div>
      <div class="col card"><small class="muted">إجمالي قيمة المبيعات</small><div id="statSales" style="font-weight:700"></div></div>
      <div class="col card"><small class="muted">إجمالي قيمة المشتريات</small><div id="statPurchases" style="font-weight:700"></div></div>
    </div>
  </div>

  <!-- Sale -->
  <div id="sale" class="card section hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>إضافة مبيعة</h3>
      <div class="top-actions">
        <button onclick="printSection('salesTable')" class="btn-ghost">طباعة المبيعات</button>
        <button onclick="exportSection('sales')" class="btn-ghost">تصدير مبيعات</button>
      </div>
    </div>

    <label>تاريخ الفاتورة</label><input id="saleDate" placeholder="مثال: 2025-08-08"/>
    <label>رقم المسلسل (Serial)</label><input id="saleSerial" placeholder="مثال: S-0001"/>
    <label>رقم الفاتورة (Invoice No.)</label><input id="saleInvoice" placeholder="مثال: INV-2025-001"/>
    <label>الرقم الضريبي للعميل (Tax ID)</label><input id="saleTaxId" onblur="lookupCustomerByTax()" placeholder="اكتب رقم التسجيل الضريبي"/>
    <label>اسم العميل</label><input id="saleCustomerName" placeholder="اسم العميل"/>
    <label>اسم المشروع</label><input id="saleProjectName" placeholder="اسم المشروع"/>
    <div style="margin-top:6px" class="row">
      <div class="col"><button onclick="openAddCustomer()">أضف/تعديل عميل</button></div>
    </div>

    <label>كود الصنف (أو اختر)</label><input id="saleCode" onblur="lookupByCode('sale')" placeholder="مثال: P001"/>
    <label>اختر الصنف</label><select id="saleSelect"></select>

    <div class="row">
      <div class="col"><label>الكمية</label><input id="saleQty" type="number" value="1"/></div>
      <div class="col"><label>سعر الوحدة</label><input id="salePrice" type="number" value="0"/></div>
    </div>
    <button class="primary" onclick="recordSale()">سجل المبيعة</button>

    <h4 style="margin-top:12px">قائمة المبيعات</h4>
    <table id="salesTable"><thead><tr><th>التاريخ</th><th>مسلسل</th><th>فاتورة</th><th>مشروع</th><th>الرقم الضريبي</th><th>عميل</th><th>الصنف</th><th>كمية</th><th>سعر</th><th>حذف</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Purchase -->
  <div id="purchase" class="card section hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>إضافة مشتريات</h3>
      <div class="top-actions">
        <button onclick="printSection('purchasesTable')" class="btn-ghost">طباعة المشتريات</button>
        <button onclick="exportSection('purchases')" class="btn-ghost">تصدير مشتريات</button>
      </div>
    </div>

    <label>تاريخ فاتورة الشراء</label><input id="purchaseDate" placeholder="مثال: 2025-08-08"/>
    <label>رقم فاتورة المورد (Invoice No.)</label><input id="purchaseInvoice" placeholder="مثال: INV-P-001"/>
    <label>رقم أمر الشراء (Order No.)</label><input id="purchaseOrder" placeholder="مثال: PO-001"/>
    <label>الرقم الضريبي للمورد (Tax ID)</label><input id="purchaseTaxId" onblur="lookupSupplierByTax()" placeholder="اكتب رقم التسجيل الضريبي"/>
    <label>اسم المورد</label><input id="purchaseSupplierName" placeholder="اسم المورد"/>
    <div style="margin-top:6px" class="row"><div class="col"><button onclick="openAddSupplier()">أضف/تعديل مورد</button></div></div>

    <label>كود الصنف (أو اختر)</label><input id="purchaseCode" onblur="lookupByCode('purchase')" placeholder="مثال: P001"/>
    <label>اختر الصنف</label><select id="purchaseSelect"></select>
    <div class="row">
      <div class="col"><label>الكمية</label><input id="purchaseQty" type="number" value="1"/></div>
      <div class="col"><label>سعر الوحدة</label><input id="purchasePrice" type="number" value="0"/></div>
    </div>
    <label>طريقة السداد</label><select id="payMethod"><option value="cash">كاش</option><option value="credit">آجل</option></select>
    <button class="primary" onclick="recordPurchase()">سجل المشتريات</button>

    <h4 style="margin-top:12px">قائمة المشتريات</h4>
    <table id="purchasesTable"><thead><tr><th>التاريخ</th><th>فاتورة</th><th>أمر</th><th>الرقم الضريبي</th><th>مورد</th><th>الصنف</th><th>كمية</th><th>سعر</th><th>طريقة</th><th>حذف</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Stock -->
  <div id="stock" class="card section hidden">
    <h3>رصيد المخزن</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button onclick="nav('products')" class="btn-ghost">إدارة الأصناف</button>
      <button onclick="exportSection('products')" class="btn-ghost">تصدير المخزن</button>
      <button onclick="printSection('stockTable')" class="btn-ghost">طباعة</button>
    </div>
    <table id="stockTable"><thead><tr><th>كود</th><th>الصنف</th><th>الكمية</th><th>سعر</th><th>حذف</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Products -->
  <div id="products" class="card section hidden">
    <h3>الأصناف</h3>
    <label>كود الصنف</label><input id="prodCode"/>
    <label>اسم الصنف</label><input id="prodName"/>
    <label>كمية ابتدائية</label><input id="prodQty" type="number" value="0"/>
    <label>سعر افتراضي (اختياري)</label><input id="prodPrice" type="number" value="0"/>
    <button class="primary" onclick="addProduct()">أضف صنف</button>
    <h4 style="margin-top:12px">قائمة الأصناف</h4>
    <table id="productsTable"><thead><tr><th>كود</th><th>اسم</th><th>كمية</th><th>سعر</th><th>حذف</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Suppliers -->
  <div id="suppliers" class="card section hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>الموردين</h3>
      <div class="top-actions">
        <button onclick="printSection('suppliersTable')" class="btn-ghost">طباعة الموردين</button>
        <button onclick="exportSection('suppliers')" class="btn-ghost">تصدير موردين</button>
      </div>
    </div>

    <label>أضف مورد (Tax ID)</label><input id="supplierTax" placeholder="رقم التسجيل الضريبي"/>
    <label>اسم المورد</label><input id="supplierName"/>
    <button class="primary" onclick="addSupplier()">أضف مورد</button>

    <h4 style="margin-top:12px">قائمة الموردين</h4>
    <table id="suppliersTable"><thead><tr><th>Tax ID</th><th>الاسم</th><th>الرصيد</th><th>عرض</th><th>حذف</th></tr></thead><tbody></tbody></table>

    <div id="supplierAccount" class="hidden" style="margin-top:12px">
      <h4>حساب المورد: <span id="supplierNameView"></span> — رصيد: <span id="supplierBalanceView"></span></h4>
      <label>المبلغ المدفوع</label><input id="supplierPayAmount" type="number" value="0"/>
      <button onclick="recordSupplierPayment()">سجل دفعة</button>
      <h5>سجل الحركات</h5>
      <table id="supplierLedger"><thead><tr><th>التاريخ</th><th>النوع</th><th>ملاحظة</th><th>المبلغ</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Customers -->
  <div id="customers" class="card section hidden">
    <h3>العملاء</h3>
    <label>أضف عميل (Tax ID)</label><input id="customerTax" placeholder="رقم التسجيل الضريبي"/>
    <label>اسم العميل</label><input id="customerName"/>
    <button class="primary" onclick="addCustomer()">أضف عميل</button>

    <h4 style="margin-top:12px">قائمة العملاء</h4>
    <table id="customersTable"><thead><tr><th>Tax ID</th><th>الاسم</th><th>حذف</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Users -->
  <div id="users" class="card section hidden">
    <h3>المستخدمون</h3>
    <label>اسم المستخدم</label><input id="newUserName"/>
    <label>كلمة المرور</label><input id="newUserPass"/>
    <label>الصلاحية</label><select id="newUserRole"><option value="admin">admin</option><option value="limited">limited</option></select>
    <button class="primary" onclick="createUser()">انشاء مستخدم</button>
    <h4 style="margin-top:12px">قائمة المستخدمين</h4>
    <table id="usersTable"><thead><tr><th>اسم</th><th>الصلاحية</th><th>حذف</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- Import/Export -->
  <div id="importExport" class="card section hidden">
    <h3>استيراد من Excel / تصدير أقسام</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <label>اختر نوع الاستيراد:</label>
      <select id="importType">
        <option value="sales">مبيعات</option>
        <option value="purchases">مشتريات</option>
        <option value="suppliers">موردين</option>
        <option value="products">أصناف</option>
      </select>
      <input id="excelFile" type="file" accept=".xlsx,.xls,.csv" />
      <button class="btn-ghost" onclick="importExcel()">استيراد</button>
    </div>
    <small class="note">تنسيق الأعمدة: يمكن أن يحتوي الملف على رؤوس بالعربي أو بالإنجليزي. الحقول المدعومة: code, name, qty, price, date, serial, invoice, tax, supplier, customer, method, project.</small>

    <hr/>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-ghost" onclick="exportSection('products')">تصدير المخزن</button>
      <button class="btn-ghost" onclick="exportSection('sales')">تصدير المبيعات</button>
      <button class="btn-ghost" onclick="exportSection('purchases')">تصدير المشتريات</button>
      <button class="btn-ghost" onclick="exportSection('suppliers')">تصدير الموردين</button>
    </div>
  </div>

</div> <!-- appArea -->

<!-- SheetJS -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script>
/* ======= State & Storage ======= */
const KEY='inventory_full_v2_final';
let state = {
  users:[{username:'admin',password:'admin123',role:'admin'},{username:'user',password:'user123',role:'limited'}],
  products:[{code:'P001',name:'صنف A',qty:50,price:0},{code:'P002',name:'صنف B',qty:25,price:0}],
  sales:[],
  purchases:[],
  suppliers:[],
  customers:[]
};
let currentUser=null;

/* load/save */
function load(){ try{ const s=localStorage.getItem(KEY); if(s) state=JSON.parse(s); }catch(e){console.warn(e);} loadBrand(); }
function save(){ localStorage.setItem(KEY,JSON.stringify(state)); }

/* brand (logo + name) */
function loadBrand(){
  const name = localStorage.getItem(KEY + '_brand_name') || '';
  const logo = localStorage.getItem(KEY + '_brand_logo') || '';
  if(name){ document.getElementById('brandName').innerText = name; document.getElementById('brandName').style.display='block'; } else document.getElementById('brandName').innerText = '';
  if(logo){ const img = document.getElementById('brandLogo'); img.src = logo; img.classList.remove('hidden'); } else document.getElementById('brandLogo').classList.add('hidden');
  // also put into login inputs
  document.getElementById('companyNameInput') && (document.getElementById('companyNameInput').value = name);
}
function saveBrand(name, dataURL){
  if(name!==undefined) localStorage.setItem(KEY + '_brand_name', name);
  if(dataURL!==undefined) localStorage.setItem(KEY + '_brand_logo', dataURL);
  loadBrand();
}
function clearBrand(){
  localStorage.removeItem(KEY + '_brand_name');
  localStorage.removeItem(KEY + '_brand_logo');
  loadBrand();
}

/* helpers */
function uid(){ return Date.now().toString(36) + Math.floor(Math.random()*10000).toString(36); }
function formatDate(){ return new Date().toLocaleString(); }
function findProduct(code){ return state.products.find(p=>String(p.code).toLowerCase()===String(code).toLowerCase()); }
function findSupplierByTax(t){ return state.suppliers.find(s=>String(s.tax).toLowerCase()===String(t).toLowerCase()); }
function findCustomerByTax(t){ return state.customers.find(c=>String(c.tax).toLowerCase()===String(t).toLowerCase()); }

/* ======= Auth ======= */
function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  
  if(!u || !p) {
    showError('يجب إدخال اسم المستخدم وكلمة المرور');
    return;
  }

  const found = state.users.find(x => x.username === u && x.password === p);
  
  if(!found) {
    showError('اسم المستخدم أو كلمة المرور غير صحيحة');
    return;
  }
  
  // تخزين وقت آخر دخول
  found.lastLogin = new Date().toISOString();
  currentUser = found;
  
  // إخفاء صفحة الدخول وإظهار التطبيق
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('appArea').classList.remove('hidden');
  
  // تحديث الصلاحيات
  updatePermissions();
  
  loadBrand();
  nav('dashboard');
  save();
}

function showError(message) {
  const errorEl = document.getElementById('loginError');
  errorEl.innerText = message;
  errorEl.style.display = 'block';
  setTimeout(() => errorEl.style.display = 'none', 3000);
}

// تحسين إدارة الصلاحيات
function updatePermissions() {
  const isAdmin = currentUser.role === 'admin';
  
  // إظهار/إخفاء عناصر حسب الصلاحية
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });
  
  // تحديث القوائم
  document.getElementById('btnProducts').style.display = isAdmin ? '' : 'none';
  document.getElementById('btnSuppliers').style.display = isAdmin ? '' : 'none';
  document.getElementById('btnCustomers').style.display = isAdmin ? '' : 'none';
  document.getElementById('btnUsers').style.display = isAdmin ? '' : 'none';
}

function logout(){ save(); location.reload(); }

/* ======= Navigation ======= */
function nav(id){
  // إخفاء جميع الأقسام
  document.querySelectorAll('.section').forEach(s => {
    s.classList.add('hidden');
  });
  
  // إظهار القسم المطلوب
  const section = document.getElementById(id);
  if(section) {
    section.classList.remove('hidden');
    
    // تمرير التركيز إلى أول عنصر قابل للتفاعل
    const firstInput = section.querySelector('input, select, button');
    if(firstInput) firstInput.focus();
  }
  
  refreshAll();
}

/* ======= Refresh UI ======= */
function refreshAll(){
  document.getElementById('statItems').innerText = state.products.length;
  const totalSales = state.sales.reduce((s,x)=>s + (Number(x.qty)*Number(x.price||0)),0);
  const totalPurch = state.purchases.reduce((s,x)=>s + (Number(x.qty)*Number(x.price||0)),0);
  document.getElementById('statSales').innerText = totalSales.toFixed(2);
  document.getElementById('statPurchases').innerText = totalPurch.toFixed(2);

  // clear lists
  const tbSelectors = ['#productsTable tbody','#stockTable tbody','#suppliersTable tbody','#customersTable tbody','#usersTable tbody','#salesTable tbody','#purchasesTable tbody','#supplierLedger tbody'];
  document.querySelectorAll(tbSelectors.join(',')).forEach(tb=>{ if(tb) tb.innerHTML=''; });

  // clear selects
  const sSel = document.getElementById('saleSelect'); const pSel = document.getElementById('purchaseSelect');
  if(sSel) sSel.innerHTML=''; if(pSel) pSel.innerHTML='';

  // products
  state.products.forEach(p=>{
    const opt = `<option value="${p.code}">${p.code} — ${p.name}</option>`;
    if(sSel) sSel.insertAdjacentHTML('beforeend', opt);
    if(pSel) pSel.insertAdjacentHTML('beforeend', opt);
    const delBtn = currentUser && currentUser.role==='admin' ? `<button onclick="deleteProduct('${p.code}')">حذف</button>` : '';
    document.querySelector('#productsTable tbody').insertAdjacentHTML('beforeend', `<tr><td>${p.code}</td><td>${p.name}</td><td>${p.qty}</td><td>${p.price||0}</td><td>${delBtn}</td></tr>`);
    document.querySelector('#stockTable tbody').insertAdjacentHTML('beforeend', `<tr><td>${p.code}</td><td>${p.name}</td><td>${p.qty}</td><td>${p.price||0}</td><td>${delBtn}</td></tr>`);
  });

  // suppliers
  state.suppliers.forEach(s=>{
    const del = currentUser && currentUser.role==='admin' ? `<button onclick="deleteSupplier('${s.tax}')">حذف</button>` : '';
    document.querySelector('#suppliersTable tbody').insertAdjacentHTML('beforeend', `<tr><td>${s.tax}</td><td>${s.name}</td><td>${(s.balance||0).toFixed(2)}</td><td><button onclick="openSupplierAccount('${s.tax}')">عرض</button></td><td>${del}</td></tr>`);
  });

  // customers
  state.customers.forEach(c=>{
    const del = currentUser && currentUser.role==='admin' ? `<button onclick="deleteCustomer('${c.tax}')">حذف</button>` : '';
    document.querySelector('#customersTable tbody').insertAdjacentHTML('beforeend', `<tr><td>${c.tax}</td><td>${c.name}</td><td>${del}</td></tr>`);
  });

  // sales
  state.sales.forEach(s=>{
    const del = currentUser && currentUser.role==='admin' ? `<button onclick="deleteSale('${s.id}')">حذف</button>` : '';
    document.querySelector('#salesTable tbody').insertAdjacentHTML('beforeend', `<tr><td>${s.date||''}</td><td>${s.serial||''}</td><td>${s.invoice||''}</td><td>${s.project||''}</td><td>${s.tax||''}</td><td>${s.customer||''}</td><td>${s.item_name||''}</td><td>${s.qty}</td><td>${s.price}</td><td>${del}</td></tr>`);
  });

  // purchases
  state.purchases.forEach(p=>{
    const del = currentUser && currentUser.role==='admin' ? `<button onclick="deletePurchase('${p.id}')">حذف</button>` : '';
    document.querySelector('#purchasesTable tbody').insertAdjacentHTML('beforeend', `<tr><td>${p.date||''}</td><td>${p.invoice||''}</td><td>${p.serial||''}</td><td>${p.tax||''}</td><td>${p.supplier||''}</td><td>${p.item_name||''}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.method}</td><td>${del}</td></tr>`);
  });

  // users
  state.users.forEach(u=>{
    const del = currentUser && currentUser.role==='admin' ? `<button onclick="deleteUser('${u.username}')">حذف</button>` : '';
    document.querySelector('#usersTable tbody').insertAdjacentHTML('beforeend', `<tr><td>${u.username}</td><td>${u.role}</td><td>${del}</td></tr>`);
  });

  save();
}

/* ======= Lookup & small helpers ======= */
function lookupCustomerByTax(){ const tax=document.getElementById('saleTaxId').value.trim(); if(!tax) return; const c=findCustomerByTax(tax); if(c) document.getElementById('saleCustomerName').value=c.name; else document.getElementById('saleCustomerName').value=''; }
function lookupSupplierByTax(){ const tax=document.getElementById('purchaseTaxId').value.trim(); if(!tax) return; const s=findSupplierByTax(tax); if(s) document.getElementById('purchaseSupplierName').value=s.name; else document.getElementById('purchaseSupplierName').value=''; }
function lookupByCode(context){ const code=(context==='sale'?document.getElementById('saleCode').value:document.getElementById('purchaseCode').value).trim(); if(!code) return; const p=findProduct(code); if(!p) return alert('كود غير موجود'); if(context==='sale') document.getElementById('saleSelect').value=p.code; else document.getElementById('purchaseSelect').value=p.code; }

/* ======= Customers / Suppliers CRUD ======= */
function addCustomer(){ const tax=document.getElementById('customerTax').value.trim(); const name=document.getElementById('customerName').value.trim(); if(!tax||!name) return showAlert('اكمل بيانات العميل'); if(findCustomerByTax(tax)) return showAlert('هذا العميل موجود بالفعل'); state.customers.push({tax,name}); document.getElementById('customerTax').value=''; document.getElementById('customerName').value=''; save(); refreshAll(); showAlert('تم إضافة العميل', 'success'); }
function addSupplier(){ const tax=document.getElementById('supplierTax').value.trim(); const name=document.getElementById('supplierName').value.trim(); if(!tax||!name) return showAlert('اكمل بيانات المورد'); if(findSupplierByTax(tax)) return showAlert('المورد موجود'); state.suppliers.push({tax,name,balance:0,ledger:[]}); document.getElementById('supplierTax').value=''; document.getElementById('supplierName').value=''; save(); refreshAll(); showAlert('تم إضافة المورد', 'success'); }
function openAddCustomer(){ const tax=document.getElementById('saleTaxId').value.trim(); const name=document.getElementById('saleCustomerName').value.trim(); if(!tax||!name) return showAlert('ادخل رقم ضريبي واسم العميل أولاً في الحقول'); const exist=findCustomerByTax(tax); if(exist){ exist.name=name; showAlert('تم تعديل العميل', 'success'); } else state.customers.push({tax,name}); save(); refreshAll(); }
function openAddSupplier(){ const tax=document.getElementById('purchaseTaxId').value.trim(); const name=document.getElementById('purchaseSupplierName').value.trim(); if(!tax||!name) return showAlert('ادخل رقم ضريبي واسم المورد أولاً في الحقول'); const exist=findSupplierByTax(tax); if(exist){ exist.name=name; showAlert('تم تعديل المورد', 'success'); } else state.suppliers.push({tax,name,balance:0,ledger:[]}); save(); refreshAll(); }

/* ======= Sales / Purchases ======= */
function recordSale(){
  if(!currentUser) return showAlert('سجل دخول', 'error');
  const date=document.getElementById('saleDate').value.trim();
  const serial=document.getElementById('saleSerial').value.trim();
  const invoice=document.getElementById('saleInvoice').value.trim();
  const tax=document.getElementById('saleTaxId').value.trim();
  const customerName=document.getElementById('saleCustomerName').value.trim();
  const project=document.getElementById('saleProjectName').value.trim();
  const code=document.getElementById('saleSelect').value;
  const qty=Number(document.getElementById('saleQty').value)||0;
  const price=Number(document.getElementById('salePrice').value)||0;
  if(!date) return showAlert('اكتب تاريخ الفاتورة', 'error');
  if(!serial) return showAlert('اكتب رقم المسلسل', 'error');
  if(!invoice) return showAlert('اكتب رقم الفاتورة', 'error');
  if(!code) return showAlert('اختر صنف', 'error');
  if(qty<=0) return showAlert('الكمية لازم تكون أكبر من صفر', 'error');
  const p=findProduct(code);
  if(!p) return showAlert('الصنف غير موجود', 'error');
  if(p.qty < qty) return showAlert('الكمية في المخزن أقل من المطلوب', 'error');
  p.qty -= qty;
  const rec={id:uid(), date, serial, invoice, tax, customer: customerName, project, item_code: p.code, item_name: p.name, qty, price, user: currentUser.username};
  state.sales.push(rec);
  save(); refreshAll(); showAlert('تم تسجيل المبيعة', 'success');
}

function recordPurchase(){
  if(!currentUser) return showAlert('سجل دخول', 'error');
  const date=document.getElementById('purchaseDate').value.trim();
  const invoice=document.getElementById('purchaseInvoice').value.trim();
  const order=document.getElementById('purchaseOrder').value.trim();
  const tax=document.getElementById('purchaseTaxId').value.trim();
  const supplierName=document.getElementById('purchaseSupplierName').value.trim();
  const code=document.getElementById('purchaseSelect').value;
  const qty=Number(document.getElementById('purchaseQty').value)||0;
  const price=Number(document.getElementById('purchasePrice').value)||0;
  const method=document.getElementById('payMethod').value;
  if(!date) return showAlert('اكتب تاريخ فاتورة الشراء', 'error');
  if(!invoice) return showAlert('اكتب رقم الفاتورة', 'error');
  if(!order) return showAlert('اكتب رقم أمر الشراء', 'error');
  if(!code) return showAlert('اختر صنف', 'error');
  if(qty<=0) return showAlert('الكمية لازم > 0', 'error');

  let supplier = findSupplierByTax(tax);
  if(!supplier){
    if(tax){
      supplier = {tax, name: supplierName || 'اسم غير معروف', balance:0, ledger:[]}; state.suppliers.push(supplier);
    } else {
      supplier = state.suppliers.find(s=>s.name===supplierName) || {tax:'', name: supplierName || 'اسم غير معروف', balance:0, ledger:[]};
      if(!state.suppliers.includes(supplier)) state.suppliers.push(supplier);
    }
  }

  let p = findProduct(code);
  if(!p){
    const name = prompt('الصنف غير موجود. اكتب اسم الصنف لإضافته:','');
    if(!name) return showAlert('تم الإلغاء', 'info');
    p = {code, name, qty:0, price: price||0}; state.products.push(p);
  }

  p.qty += qty; if(price) p.price = price;
  const rec={id: uid(), date, invoice, serial: order, tax, supplier: supplier.name, item_code: p.code, item_name: p.name, qty, price, method, user: currentUser.username};
  state.purchases.push(rec);

  if(method==='credit'){
    const amount = qty * price;
    supplier.balance = Number((Number(supplier.balance||0) + amount).toFixed(2));
    supplier.ledger = supplier.ledger || []; supplier.ledger.push({date: formatDate(), type:'purchase', note:`أمر ${order||''}`, amount});
  }
  save(); refreshAll(); showAlert('تم تسجيل المشتريات', 'success');
}

/* ======= Supplier account & payments ======= */
function openSupplierAccount(tax){
  const sup = findSupplierByTax(tax); if(!sup) return showAlert('مورد غير موجود', 'error');
  document.getElementById('supplierAccount').classList.remove('hidden');
  document.getElementById('supplierNameView').innerText = sup.name;
  document.getElementById('supplierBalanceView').innerText = (sup.balance||0).toFixed(2);
  const tbody=document.querySelector('#supplierLedger tbody'); tbody.innerHTML='';
  (sup.ledger||[]).forEach(l=> tbody.insertAdjacentHTML('beforeend', `<tr><td>${l.date}</td><td>${l.type}</td><td>${l.note||''}</td><td>${l.amount}</td></tr>`));
  document.getElementById('supplierAccount').dataset.currentSupplier = sup.tax;
}
function recordSupplierPayment(){ const tax=document.getElementById('supplierAccount').dataset.currentSupplier; if(!tax) return showAlert('افتح حساب مورد اولاً', 'error'); const amount=Number(document.getElementById('supplierPayAmount').value)||0; if(amount<=0) return showAlert('اكتب مبلغ صحيح', 'error'); const sup=findSupplierByTax(tax); sup.balance = Number((Number(sup.balance||0) - amount).toFixed(2)); sup.ledger = sup.ledger || []; sup.ledger.push({date: formatDate(), type:'payment', note:'دفعة', amount:-amount}); document.getElementById('supplierPayAmount').value=''; openSupplierAccount(tax); save(); refreshAll(); showAlert('تم تسجيل الدفعة', 'success'); }

/* ======= Add product / users / delete ======= */
function addProduct(){ if(!currentUser || currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); const code=document.getElementById('prodCode').value.trim(); const name=document.getElementById('prodName').value.trim(); const qty=Number(document.getElementById('prodQty').value)||0; const price=Number(document.getElementById('prodPrice').value)||0; if(!code||!name) return showAlert('اكمل البيانات', 'error'); if(findProduct(code)) return showAlert('كود موجود', 'error'); state.products.push({code,name,qty,price}); document.getElementById('prodCode').value=''; document.getElementById('prodName').value=''; document.getElementById('prodQty').value=0; document.getElementById('prodPrice').value=0; save(); refreshAll(); showAlert('تم إضافة الصنف', 'success'); }
function createUser(){ if(!currentUser || currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); const u=document.getElementById('newUserName').value.trim(); const p=document.getElementById('newUserPass').value; const r=document.getElementById('newUserRole').value; if(!u||!p) return showAlert('اكمل', 'error'); if(state.users.find(x=>x.username===u)) return showAlert('موجود', 'error'); state.users.push({username:u,password:p,role:r}); document.getElementById('newUserName').value=''; document.getElementById('newUserPass').value=''; save(); refreshAll(); showAlert('تم إنشاء المستخدم', 'success'); }
function deleteProduct(code){ if(!currentUser||currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); if(!confirm('متأكد تحذف الصنف؟')) return; state.products = state.products.filter(p=>p.code!==code); save(); refreshAll(); showAlert('تم حذف الصنف', 'success'); }
function deleteSale(id){ if(!currentUser||currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); if(!confirm('متأكد تحذف المبيعة؟')) return; const rec=state.sales.find(s=>s.id===id); if(rec){ const p=findProduct(rec.item_code); if(p) p.qty = Number(p.qty) + Number(rec.qty); state.sales = state.sales.filter(s=>s.id!==id); save(); refreshAll(); showAlert('تم حذف المبيعة وصُحّح المخزون', 'success'); } else showAlert('سجل غير موجود', 'error'); }
function deletePurchase(id){ if(!currentUser||currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); if(!confirm('متأكد تحذف المشتريات؟')) return; const rec=state.purchases.find(p=>p.id===id); if(rec){ const prod=findProduct(rec.item_code); if(prod){ prod.qty = Number(prod.qty) - Number(rec.qty); if(prod.qty < 0) prod.qty = 0; } if(rec.method==='credit'){ const sup=state.suppliers.find(s=>s.name===rec.supplier); if(sup){ const amount = rec.qty*rec.price; sup.balance = Number((Number(sup.balance||0) - amount).toFixed(2)); sup.ledger = sup.ledger || []; sup.ledger.push({date: formatDate(), type:'reverse_purchase', note:`حذف أمر ${rec.serial||''}`, amount:-amount}); } } state.purchases = state.purchases.filter(p=>p.id!==id); save(); refreshAll(); showAlert('تم حذف المشتريات وصُحّح المخزون', 'success'); } else showAlert('سجل غير موجود', 'error'); }
function deleteSupplier(tax){ if(!currentUser||currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); state.suppliers = state.suppliers.filter(s=>s.tax!==tax); save(); refreshAll(); showAlert('تم حذف المورد', 'success'); }
function deleteCustomer(tax){ if(!currentUser||currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); state.customers = state.customers.filter(c=>c.tax!==tax); save(); refreshAll(); showAlert('تم حذف العميل', 'success'); }
function deleteUser(username){ if(!currentUser||currentUser.role!=='admin') return showAlert('ليست لديك صلاحية', 'error'); state.users = state.users.filter(u=>u.username!==username); save(); refreshAll(); showAlert('تم حذف المستخدم', 'success'); }

/* ======= Export CSV per section (with BOM) ======= */
function toCSV(rows, cols){ if(!rows || !rows.length) return ''; const header = cols.join(','); const body = rows.map(r => cols.map(c=>`"${String(r[c]===undefined?'':r[c]).replace(/"/g,'""')}"`).join(',')).join('\n'); return header + '\n' + body; }
function downloadCSV(text, filename){ const bom='\uFEFF'; const blob=new Blob([bom + text], {type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download=filename; document.body.appendChild(link); link.click(); link.remove(); }
function exportSection(section){
  if(section==='products'){ const rows = state.products.map(p=>({code:p.code,name:p.name,qty:p.qty,price:p.price||0})); const csv=toCSV(rows,['code','name','qty','price']); downloadCSV(csv,'products.csv'); }
  else if(section==='sales'){ const rows=state.sales.map(s=>({date:s.date, serial:s.serial, invoice:s.invoice, project:s.project, tax:s.tax, customer:s.customer, item_code:s.item_code, item_name:s.item_name, qty:s.qty, price:s.price, user:s.user})); const csv=toCSV(rows,['date','serial','invoice','project','tax','customer','item_code','item_name','qty','price','user']); downloadCSV(csv,'sales.csv'); }
  else if(section==='purchases'){ const rows=state.purchases.map(p=>({date:p.date, invoice:p.invoice, order:p.serial, tax:p.tax, supplier:p.supplier, item_code:p.item_code, item_name:p.item_name, qty:p.qty, price:p.price, method:p.method, user:p.user})); const csv=toCSV(rows,['date','invoice','order','tax','supplier','item_code','item_name','qty','price','method','user']); downloadCSV(csv,'purchases.csv'); }
  else if(section==='suppliers'){ const supRows=state.suppliers.map(s=>({tax:s.tax,name:s.name,balance:s.balance,ledger:JSON.stringify(s.ledger||[])})); const csv=toCSV(supRows,['tax','name','balance','ledger']); downloadCSV(csv,'suppliers.csv'); }
  else showAlert('قسم غير معروف للتصدير', 'error');
}

/* ======= Import Excel (SheetJS) ======= */
function importExcel(){
  const f=document.getElementById('excelFile').files[0]; if(!f) return showAlert('اختر ملف Excel', 'error'); const type=document.getElementById('importType').value; const reader=new FileReader();
  reader.onload = function(e){
    const data = e.target.result; let workbook;
    try{ workbook = XLSX.read(data, {type:'binary'}); } catch(err){ showAlert('فشل في قراءة الملف: ' + err.message, 'error'); return; }
    const ws = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval: ''});
    if(!json || !json.length) return showAlert('الورقة فارغة', 'error');
    const normalized = json.map(row=>{ const out={}; Object.keys(row).forEach(k=>{ out[String(k).toLowerCase().trim()] = row[k]; }); return out; });

    if(type==='products'){
      let added=0;
      normalized.forEach(r=>{
        const code=String(r['code']||r['كود']||'').trim(); const name=String(r['name']||r['اسم']||'').trim(); const qty=Number(r['qty']||r['كمية']||0)||0; const price=Number(r['price']||r['سعر']||0)||0;
        if(!code||!name) return; const ex=findProduct(code); if(ex){ ex.qty = Number(ex.qty) + qty; if(price) ex.price = price; } else state.products.push({code,name,qty,price}); added++;
      });
      save(); refreshAll(); showAlert('تم استيراد الأصناف: ' + added, 'success');
    } else if(type==='suppliers'){
      let added=0;
      normalized.forEach(r=>{ const tax=String(r['tax']||r['الرقم الضريبي']||'').trim(); const name=String(r['name']||r['اسم']||'').trim(); const balance=Number(r['balance']||r['رصيد']||0)||0; if(!tax||!name) return; const ex=findSupplierByTax(tax); if(ex){ ex.name=name; ex.balance=balance; } else state.suppliers.push({tax,name,balance,ledger:[]}); added++; });
      save(); refreshAll(); showAlert('تم استيراد الموردين: ' + added, 'success');
    } else if(type==='sales'){
      let added=0;
      normalized.forEach(r=>{
        const date = r['date']||r['تاريخ']||''; const serial = r['serial']||r['مسلسل']||''; const invoice = r['invoice']||r['فاتورة']||''; const project = r['project']||r['مشروع']||''; const tax = String(r['tax']||r['tax id']||r['الرقم الضريبي']||'').trim();
        const customer = String(r['customer']||r['العميل']||'').trim()||''; const code = String(r['code']||r['item_code']||r['كود']||'').trim(); const name = String(r['name']||r['item_name']||r['اسم']||'').trim();
        const qty = Number(r['qty']||r['quantity']||r['كمية']||0)||0; const price = Number(r['price']||r['سعر']||0)||0;
        if(!code || qty<=0) return;
        let p=findProduct(code);
        if(!p){ p={code, name:name||code, qty:0, price:price||0}; state.products.push(p); }
        if(p.qty < qty){ console.warn(`لا تكفي كمية ${code}`); return; }
        p.qty = Number(p.qty) - qty;
        const rec={id:uid(), date, serial, invoice, project, tax, customer, item_code:p.code, item_name:p.name, qty, price, user: currentUser?currentUser.username:'import'};
        state.sales.push(rec); added++;
      });
      save(); refreshAll(); showAlert('تم استيراد المبيعات (المضافة: ' + added + ')', 'success');
    } else if(type==='purchases'){
      let added=0;
      normalized.forEach(r=>{
        const date=r['date']||r['تاريخ']||''; const invoice=r['invoice']||r['فاتورة']||''; const order=r['order']||r['serial']||r['أمر']||''; const tax=String(r['tax']||r['tax id']||r['الرقم الضريبي']||'').trim();
        const supplierName=String(r['supplier']||r['المورد']||'').trim()||''; const code=String(r['code']||r['item_code']||r['كود']||'').trim();
        const name=String(r['name']||r['item_name']||r['اسم']||'').trim(); const qty=Number(r['qty']||r['quantity']||r['كمية']||0)||0; const price=Number(r['price']||r['سعر']||0)||0; const method=String(r['method']||r['طريقة']||'cash').trim();
        if(!code || qty<=0) return;
        let supplier = findSupplierByTax(tax);
        if(!supplier){ supplier = state.suppliers.find(s=>s.name===supplierName) || {tax:tax||'', name: supplierName||'اسم غير معروف', balance:0, ledger:[]}; if(!state.suppliers.includes(supplier)) state.suppliers.push(supplier); }
        let p=findProduct(code);
        if(!p){ p={code, name:name||code, qty:0, price:price||0}; state.products.push(p); }
        p.qty = Number(p.qty) + qty; if(price) p.price = price;
        const rec={id:uid(), date, invoice, serial:order, tax, supplier: supplier.name, item_code:p.code, item_name:p.name, qty, price, method, user: currentUser?currentUser.username:'import'};
        state.purchases.push(rec);
        if(method==='credit'){ const amount=qty*price; supplier.balance = Number((Number(supplier.balance||0) + amount).toFixed(2)); supplier.ledger=supplier.ledger||[]; supplier.ledger.push({date: formatDate(), type:'purchase', note:`أمر ${order||''}`, amount}); }
        added++;
      });
      save(); refreshAll(); showAlert('تم استيراد المشتريات (المضافة: ' + added + ')', 'success');
    }
  };
  reader.onerror = () => showAlert('حدث خطأ أثناء قراءة الملف', 'error');
  reader.readAsBinaryString(f);
}

/* ======= Print section (include logo & company name) ======= */
function printSection(tableId){
  const table=document.getElementById(tableId);
  if(!table) return showAlert('الجدول غير موجود', 'error');
  const brandName = localStorage.getItem(KEY + '_brand_name') || '';
  const brandLogo = localStorage.getItem(KEY + '_brand_logo') || '';
  const newWin = window.open('','طباعة','width=900,height=700');
  const style = `<style>body{font-family:Arial, Tahoma;direction:rtl;padding:12px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;text-align:right}header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}header img{height:60px}</style>`;
  newWin.document.write(`<html><head><meta charset="utf-8"><title>طباعة</title>${style}</head><body>`);
  newWin.document.write(`<header>`);
  if(brandLogo) newWin.document.write(`<div><img src="${brandLogo}" alt="logo"></div>`);
  newWin.document.write(`<div style="text-align:right"><h2>${brandName||''}</h2><div class="muted">${new Date().toLocaleString()}</div></div>`);
  newWin.document.write(`</header>`);
  newWin.document.write(table.outerHTML);
  newWin.document.write('</body></html>');
  newWin.document.close();
  newWin.focus();
  setTimeout(()=>{ newWin.print(); newWin.close(); }, 300);
}

/* ======= Backup & Restore ======= */
function backup(){ 
  const data = {
    version: '1.0',
    createdAt: new Date().toISOString(),
    data: state,
    metadata: {
      user: currentUser?.username || 'unknown',
      itemCount: state.products.length,
      salesCount: state.sales.length
    }
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  
  showAlert(`تم إنشاء نسخة احتياطية تحتوي على:
- ${state.products.length} أصناف
- ${state.sales.length} مبيعات
- ${state.purchases.length} مشتريات`, 'success');
}

function restorePrompt(){ 
  const fileInput=document.createElement('input'); 
  fileInput.type='file'; 
  fileInput.accept='.json'; 
  fileInput.onchange=(e)=>{ 
    const f=e.target.files[0]; 
    if(!f) return; 
    const r=new FileReader(); 
    r.onload=function(evt){ 
      try{ 
        const obj=JSON.parse(evt.target.result); 
        if(confirm('هل تريد استبدال البيانات الحالية بالبيانات الموجودة في الملف؟')){ 
          state=obj.data || obj; 
          save(); 
          refreshAll(); 
          showAlert('تم الاستعادة', 'success'); 
        } 
      }catch(err){ 
        showAlert('ملف غير صحيح', 'error'); 
      } 
    }; 
    r.readAsText(f); 
  }; 
  fileInput.click(); 
}

/* ======= UI Helpers ======= */
function showAlert(message, type = 'info') {
  const colors = {
    info: '#0b74de',
    success: '#15803d',
    warning: '#d97706',
    error: '#b91c1c'
  };
  
  const alertDiv = document.createElement('div');
  alertDiv.style.position = 'fixed';
  alertDiv.style.top = '20px';
  alertDiv.style.right = '20px';
  alertDiv.style.padding = '12px 16px';
  alertDiv.style.borderRadius = '4px';
  alertDiv.style.backgroundColor = colors[type] || colors.info;
  alertDiv.style.color = 'white';
  alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  alertDiv.style.zIndex = '1000';
  alertDiv.style.maxWidth = '400px';
  alertDiv.style.animation = 'fadeIn 0.3s ease';
  alertDiv.innerText = message;
  
  document.body.appendChild(alertDiv);
  
  setTimeout(() => {
    alertDiv.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => alertDiv.remove(), 300);
  }, 3000);
}

function showLoading(message) {
  // يمكنك إضافة شاشة تحميل هنا إذا لزم الأمر
  console.log('جاري التحميل: ' + message);
}

function hideLoading() {
  // إخفاء شاشة التحميل
  console.log('تم التحميل');
}

/* ======= Initialize ======= */
load();
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('appArea').classList.add('hidden');
  // handle logo upload on login page
  const logoInput = document.getElementById('companyLogoInput');
  if(logoInput){
    logoInput.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(evt){
        const dataURL = evt.target.result;
        const name = document.getElementById('companyNameInput').value || localStorage.getItem(KEY + '_brand_name') || '';
        saveBrand(name, dataURL);
        showAlert('تم حفظ شعار الشركة محليًا', 'success');
      };
      reader.readAsDataURL(f);
    });
  }
  // save company name on input blur
  const compInput = document.getElementById('companyNameInput');
  if(compInput){
    compInput.addEventListener('blur', (e)=>{ saveBrand(e.target.value, undefined); });
  }
  refreshAll();
});
</script>
</body>

</html>
